// apps/server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== 枚举定义 ====================

/// 用户状态枚举
enum UserStatus {
  ACTIVE    // 正常激活
  INACTIVE  // 未激活/待验证
  BANNED    // 已封禁
  DELETED   // 已注销
}

/// 第三方登录平台枚举
enum SocialProvider {
  github
  google
  linuxdo
}

/// 验证码类型枚举
enum VerificationCodeType {
  register         // 注册
  login           // 登录
  forgot_password // 找回密码
  bind_email      // 绑定邮箱
  bind_phone      // 绑定手机号
}

// ==================== 核心表 ====================

/// 用户表 - 存储核心用户信息
model User {
  id           String     @id @default(uuid())
  /// 用户名，唯一，系统自动生成，用户可修改
  username     String     @unique
  /// 昵称，显示名称
  nickname     String?
  /// 密码哈希值 (bcrypt)
  passwordHash String?    @map("password_hash")
  /// 邮箱地址，用于登录和通知
  email        String?    @unique
  /// 邮箱是否已验证
  emailVerified Boolean   @default(false) @map("email_verified")
  /// 手机号 (预留扩展)
  phone        String?    @unique
  /// 手机号是否已验证 (预留扩展)
  phoneVerified Boolean   @default(false) @map("phone_verified")
  /// 用户头像 URL
  avatar       String?
  /// 账号状态
  status       UserStatus @default(ACTIVE)
  
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // 关联关系
  socialAccounts SocialAccount[]
  sessions       Session[]
  watchlistGroups WatchlistGroup[]

  @@index([email])
  @@index([username])
  @@index([phone])
  @@index([status])
  @@map("users")
}

/// 第三方登录账号表 - 关联用户与第三方平台
model SocialAccount {
  id         String         @id @default(uuid())
  userId     String         @map("user_id")
  /// 第三方平台 (github/google/linuxdo)
  provider   SocialProvider
  /// 第三方平台的唯一用户 ID
  providerId String         @map("provider_id")
  /// 第三方平台返回的用户名
  providerUsername String?   @map("provider_username")
  /// 第三方平台返回的邮箱
  providerEmail    String?   @map("provider_email")
  /// 第三方平台返回的头像
  providerAvatar   String?   @map("provider_avatar")
  /// UnionId (可选，用于跨应用识别同一用户)
  unionId    String?        @map("union_id")
  /// OAuth Access Token (加密存储)
  accessToken String?       @map("access_token")
  /// OAuth Refresh Token (加密存储)
  refreshToken String?      @map("refresh_token")
  /// Token 过期时间
  expiresAt   DateTime?     @map("expires_at")
  
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("social_accounts")
}

/// 用户会话表 - 存储 Access Token 和 Refresh Token
model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  
  /// Access Token (JWT，用于 API 访问验证)
  accessToken  String   @unique @map("access_token")
  
  /// Access Token 过期时间
  accessTokenExpiresAt DateTime @map("access_token_expires_at")
  
  /// Refresh Token (用于刷新 Access Token)
  refreshToken String   @unique @map("refresh_token")
  
  /// Refresh Token 过期时间
  refreshTokenExpiresAt DateTime @map("refresh_token_expires_at")
  
  /// 登录时的 IP 地址
  ipAddress    String?  @map("ip_address")
  
  /// User Agent (浏览器/设备信息)
  userAgent    String?  @map("user_agent")
  
  /// 最后活跃时间
  lastActiveAt DateTime? @map("last_active_at")
  
  /// 是否已撤销 (用于主动登出)
  revoked      Boolean  @default(false)
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accessToken])
  @@index([refreshToken])
  @@index([accessTokenExpiresAt])
  @@index([revoked])
  @@map("sessions")
}

/// 验证码表 - 存储邮箱/手机验证码
model VerificationCode {
  id        String               @id @default(uuid())
  /// 接收者 (邮箱或手机号)
  target    String
  /// 验证码
  code      String
  /// 验证码类型
  type      VerificationCodeType
  /// 过期时间
  expiresAt DateTime             @map("expires_at")
  /// 使用时间 (null 表示未使用)
  usedAt    DateTime?            @map("used_at")
  /// 创建时的 IP 地址 (防刷)
  ipAddress String?              @map("ip_address")
  
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  @@index([target, type])
  @@index([expiresAt])
  @@map("verification_codes")
}

// ==================== 投资模块枚举 ====================

/// 资产类型枚举
enum AssetType {
  STOCK   // A股
  INDEX   // 指数
  ETF     // ETF
  LOF     // LOF基金
  OFUND   // 场外基金 (Outdoor Fund)
}

/// 指数类型枚举
enum IndexType {
  BROAD     // 大盘指数 (如 上证指数、深证成指)
  SECTOR    // 行业指数 (如 半导体指数、白酒指数)
  THEME     // 主题指数 (如 新能源指数)
  STRATEGY  // 策略指数 (如 红利指数、指数增强)
}

/// 交易所/板块枚举
enum Exchange {
  SSE   // 上海证券交易所
  SZSE  // 深圳证券交易所
  BJSE  // 北京证券交易所
  HKEX  // 香港联合交易所
}

/// 场外基金类型枚举 (完整 32 种)
enum FundType {
  // 货币型 (2种)
  MONEY_NORMAL       // 货币型-普通货币
  MONEY_FLOATING     // 货币型-浮动净值
  
  // 债券型 (4种)
  BOND_LONG          // 债券型-长债
  BOND_SHORT         // 债券型-中短债
  BOND_MIXED_1       // 债券型-混合一级
  BOND_MIXED_2       // 债券型-混合二级
  
  // 混合型 (5种)
  MIXED_STOCK        // 混合型-偏股
  MIXED_BOND         // 混合型-偏债
  MIXED_BALANCED     // 混合型-平衡
  MIXED_FLEXIBLE     // 混合型-灵活
  MIXED_ABSOLUTE     // 混合型-绝对收益
  
  // 股票型 (1种)
  STOCK              // 股票型
  
  // 指数型 (4种)
  INDEX_STOCK        // 指数型-股票
  INDEX_BOND         // 指数型-固收
  INDEX_OVERSEAS     // 指数型-海外股票
  INDEX_OTHER        // 指数型-其他
  
  // QDII (9种)
  QDII_STOCK         // QDII-普通股票
  QDII_MIXED_STOCK   // QDII-混合偏股
  QDII_MIXED_BOND    // QDII-混合债
  QDII_MIXED_FLEXIBLE// QDII-混合灵活
  QDII_MIXED_BALANCED// QDII-混合平衡
  QDII_BOND          // QDII-纯债
  QDII_COMMODITY     // QDII-商品
  QDII_FOF           // QDII-FOF
  QDII_REIT          // QDII-REITs
  
  // FOF (3种)
  FOF_CONSERVATIVE   // FOF-稳健型
  FOF_BALANCED       // FOF-均衡型
  FOF_AGGRESSIVE     // FOF-进取型
  
  // 另类 (3种)
  REIT               // Reits/REITs
  COMMODITY          // 商品
  OTHER              // 其他/空值
}

/// 市场枚举
enum AssetMarket {
  CN // 中国 (A股/场内)
  HK // 香港
  US // 美国
}

// ==================== 投资模块核心表 ====================

/// 资产基础信息表 - 仅存储搜索和列表展示必需的静态信息
/// 其他动态数据（行情、财务、持仓等）从 Python 服务实时获取
model Asset {
  id              String      @id @default(uuid())
  /// 标的代码 (如 600519 贵州茅台, 000001 上证指数, 005827 易方达蓝筹精选)
  symbol          String
  /// 标的名称
  name            String
  /// 资产类型 (STOCK/INDEX/ETF/LOF/OFUND)
  type            AssetType
  /// 所属市场 (CN/HK/US)
  market          AssetMarket
  /// 交易所/板块 (SSE/SZSE/BJSE/HKEX)，指数和场内品种有值
  exchange        Exchange?
  /// 指数类型 (仅 INDEX 类型有值)
  indexType       IndexType?
  /// 基金公司 (ETF/LOF/场外基金有值)
  fundCompany     String?     @map("fund_company")
  /// 场外基金类型 (仅 OFUND 类型有值)
  fundType        FundType?   @map("fund_type")
  /// 拼音首字母 (用于搜索，如 "ZGMT" 为中国平安)
  pinyinInitial   String?     @map("pinyin_initial")
  /// 完整拼音 (用于模糊搜索，如 "guizhoumaotai")
  pinyinFull      String?     @map("pinyin_full")
  /// 上次数据同步时间
  lastSyncedAt    DateTime?   @map("last_synced_at")

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // 关联关系
  watchlistItems  WatchlistItem[]

  @@unique([market, symbol]) // 同一市场下代码唯一
  @@index([type])
  @@index([name]) // 支持名称搜索
  @@index([pinyinInitial]) // 支持拼音首字母搜索
  @@index([pinyinFull]) // 支持拼音全拼搜索
  @@index([fundCompany]) // 支持基金公司搜索
  @@map("assets")
}

/// 自选分组表
model WatchlistGroup {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  /// 排序权重
  sortOrder   Int      @default(0) @map("sort_order")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       WatchlistItem[]

  @@index([userId])
  @@map("watchlist_groups")
}

/// 自选明细表
model WatchlistItem {
  id          String   @id @default(uuid())
  groupId     String   @map("group_id")
  assetId     String   @map("asset_id")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  group       WatchlistGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  asset       Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([groupId, assetId]) // 同一分组下主要添加一次
  @@map("watchlist_items")
}
