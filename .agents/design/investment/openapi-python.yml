openapi: 3.0.0
info:
  title: 金融数据服务 (Python)
  version: 1.0.0
  description: |
    模块化金融数据微服务，封装 AkShare、TA-Lib 等功能。

    ## 模块
    - **/akshare**: 行情数据 (股票、基金、K线)
    - **/indicators**: 技术指标计算
    - **/quant**: 量化分析 (未来)

tags:
  - name: AkShare
    description: 行情数据模块 - 封装 AkShare 库
  - name: Indicators
    description: 技术指标模块 - 封装 TA-Lib/pandas-ta
  - name: Health
    description: 健康检查

paths:
  # ==================== 健康检查 ====================
  /health:
    get:
      summary: 服务健康检查
      tags: [Health]
      responses:
        "200":
          description: 服务状态
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  modules:
                    type: array
                    items:
                      type: string
                    example: ["akshare", "indicators"]

  # ==================== AkShare 模块: 股票数据 ====================
  /akshare/stock/list:
    get:
      summary: 获取全量股票列表 (用于同步)
      tags: [AkShare]
      parameters:
        - name: market
          in: query
          required: false
          schema:
            type: string
            enum: [CN, HK, US]
          description: 市场过滤 (不传则返回所有市场)
      responses:
        "200":
          description: 全量股票列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StockInfo"

  /akshare/stock/search:
    get:
      summary: 搜索股票 (A股/港股/美股)
      tags: [AkShare]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: 搜索关键词 (代码/名称)
      responses:
        "200":
          description: 匹配的股票列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StockInfo"

  /akshare/stock/{symbol}/spot:
    get:
      summary: 获取实时行情
      tags: [AkShare]
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: market
          in: query
          required: false
          schema:
            type: string
            enum: [CN, HK, US]
      responses:
        "200":
          description: 实时行情数据
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RealtimeQuote"

  /akshare/stock/{symbol}/kline:
    get:
      summary: 获取 K 线数据
      description: 返回纯 OHLCV 数据，技术指标请使用 /indicators/calculate
      tags: [AkShare]
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: market
          in: query
          required: false
          schema:
            type: string
            enum: [CN, HK, US]
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: day
        - name: adjust
          in: query
          schema:
            type: string
            enum: ["", qfq, hfq]
            default: qfq
        - name: limit
          in: query
          schema:
            type: integer
            default: 250
            maximum: 1000
      responses:
        "200":
          description: K 线数据
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/KLinePoint"

  # ==================== AkShare 模块: 基金数据 ====================
  /akshare/fund/list:
    get:
      summary: 获取全量基金列表 (用于同步)
      tags: [AkShare]
      parameters:
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [ETF, FUND]
      responses:
        "200":
          description: 全量基金列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/FundInfo"

  /akshare/fund/search:
    get:
      summary: 搜索基金
      tags: [AkShare]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 匹配的基金列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/FundInfo"

  /akshare/fund/{symbol}/nav:
    get:
      summary: 获取场外基金最新净值
      tags: [AkShare]
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 基金净值数据
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FundNav"

  /akshare/fund/{symbol}/info:
    get:
      summary: 获取基金基本信息
      tags: [AkShare]
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 基金基本信息
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FundDetail"

  /akshare/fund/{symbol}/holdings:
    get:
      summary: 获取基金持仓
      tags: [AkShare]
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: year
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: 十大重仓股列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/FundHolding"

  # ==================== 技术指标模块 ====================
  /indicators/calculate:
    post:
      summary: 计算技术指标
      description: |
        根据传入的 K 线数据计算技术指标。

        **支持的指标**:
        - `ma(n)`: 移动平均线
        - `ema(n)`: 指数移动平均
        - `macd(fast,slow,signal)`: MACD 指标
        - `rsi(n)`: RSI 指标
        - `boll(n,std)`: 布林带
        - `kdj(n,m1,m2)`: KDJ 指标
      tags: [Indicators]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IndicatorRequest"
      responses:
        "200":
          description: 计算结果
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IndicatorResponse"

  /indicators/supported:
    get:
      summary: 获取支持的指标列表
      tags: [Indicators]
      responses:
        "200":
          description: 支持的指标
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/IndicatorMeta"

components:
  schemas:
    # ==================== AkShare 模型 ====================
    StockInfo:
      type: object
      properties:
        symbol:
          type: string
          description: 股票代码
        name:
          type: string
          description: 股票名称
        market:
          type: string
          enum: [CN, HK, US]

    FundInfo:
      type: object
      properties:
        symbol:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [ETF, FUND]

    FundDetail:
      type: object
      properties:
        symbol:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [ETF, FUND]
        manager:
          type: string
        scale:
          type: number
        establishmentDate:
          type: string
          format: date
        riskLevel:
          type: string

    FundNav:
      type: object
      properties:
        symbol:
          type: string
        nav:
          type: number
        accNav:
          type: number
        dailyReturn:
          type: number
        navDate:
          type: string
          format: date

    RealtimeQuote:
      type: object
      properties:
        price:
          type: number
        open:
          type: number
        prevClose:
          type: number
        high:
          type: number
        low:
          type: number
        volume:
          type: number
        amount:
          type: number
        change:
          type: number
        changePercent:
          type: number
        turnoverRate:
          type: number
        marketCap:
          type: number
        pe:
          type: number
        pb:
          type: number
        tradingStatus:
          type: string
          enum: [TRADING, CLOSED, SUSPENDED]
        timestamp:
          type: string
          format: date-time

    KLinePoint:
      type: object
      required: [timestamp, open, high, low, close, volume]
      properties:
        timestamp:
          type: number
          description: 时间戳 (毫秒)
        open:
          type: number
        high:
          type: number
        low:
          type: number
        close:
          type: number
        volume:
          type: number

    FundHolding:
      type: object
      properties:
        symbol:
          type: string
        name:
          type: string
        percentage:
          type: number
        reportDate:
          type: string
          format: date

    # ==================== 技术指标模型 ====================
    IndicatorRequest:
      type: object
      required: [data, indicators]
      properties:
        data:
          type: array
          description: K 线数据
          items:
            $ref: "#/components/schemas/KLinePoint"
        indicators:
          type: array
          description: 指标表达式列表
          items:
            type: string
          example: ["ma(5)", "ma(20)", "macd(12,26,9)"]

    IndicatorResponse:
      type: object
      additionalProperties: true
      description: |
        动态指标结果，key 为指标表达式。
        单值指标返回数组，多值指标返回对象。
      example:
        ma(5): [null, null, null, null, 10.12, 10.25]
        macd(12,26,9):
          dif: [0.15, 0.18]
          dea: [0.10, 0.12]
          histogram: [0.05, 0.06]

    IndicatorMeta:
      type: object
      properties:
        name:
          type: string
          description: 指标名称
        syntax:
          type: string
          description: 语法格式
        description:
          type: string
        example:
          type: string
      example:
        name: "ma"
        syntax: "ma(period)"
        description: "移动平均线"
        example: "ma(20)"
